<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
body {max-width:600px; padding:10px;}
  </style>
</head>
<body>
<nav id="TOC">
<ul>
<li><a href="#principal-component-analysis">Principal Component Analysis</a><ul>
<li><a href="#mirror-image-stimulation-pca">Mirror Image Stimulation PCA</a><ul>
<li><a href="#bartletts-test-kmo">Bartlett's test &amp; KMO</a></li>
<li><a href="#multivariate-normality">Multivariate normality</a></li>
<li><a href="#pseudo-replication">Pseudo-replication</a></li>
</ul></li>
<li><a href="#open-field-arena-pca">Open Field Arena PCA</a><ul>
<li><a href="#bartletts-test-kmo-1">Bartlett's test &amp; KMO</a></li>
<li><a href="#multivariate-normality-1">Multivariate normality</a></li>
<li><a href="#pseudo-replication-1">Pseudo-replication</a></li>
</ul></li>
<li><a href="#merge-pca-data">Merge PCA data</a></li>
</ul></li>
</ul>
</nav>



<!--pandoc
t: html
default-image-extension: png
template: templates/html.template
toc-depth: 4
toc:

t: latex
s:
S:
latex-engine: xelatex
template: templates/latex.template
default-image-extension: pdf
toc-depth: 4
toc:
-->


<h1 id="principal-component-analysis">Principal Component Analysis</h1>
<blockquote>
<p>When using PCA for data reduction rather than inferential analysis, assumption of normality is not required (Tabachnick &amp; Fidell 2001)</p>
</blockquote>
<p>We will use principal component analysis to reduce the redundancy among the behavioural measurements scored from the open field (OF) and mirror image stimulation (MIS) trials and to identify the dominant axes of behavioural variation in the OF and MIS trials. Principal components are calculated separately for the OF and MIS behavioural measurements using a correlation matrix. The behavioural dataset used in this analysis is exactly the same as used in Taylor et al. (2012) so the principal component loadings and scores are also the same.</p>
<p>To evaluate the appropriateness of this analyses we will follow Budaev's advice (2010. Using Principal Components and Factor Analysis in Animal Behaviour Research: Caveats and Guidelines. Ethology 116: 472–480.). Budaev suggests some best practices for reporting PCA results that we will follow.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(MASS) <span class="co"># MASS clashes with dplyr... so always load first</span>
<span class="kw">library</span>(pander) <span class="co"># pander clashes with dplyr... so always load first</span></code></pre>
<pre><code>## 
## Attaching package: &#39;pander&#39;
## 
## The following object is masked from &#39;package:knitr&#39;:
## 
##     pandoc</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(foreach)</code></pre>
<pre><code>## foreach: simple, scalable parallel programming from Revolution Analytics
## Use Revolution R for scalability, fault tolerance and more.
## http://www.revolutionanalytics.com</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(doMC)</code></pre>
<pre><code>## Loading required package: iterators
## Loading required package: parallel</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">registerDoMC</span>()
<span class="kw">library</span>(tidyr)
<span class="kw">library</span>(dplyr)</code></pre>
<pre><code>## 
## Attaching package: &#39;dplyr&#39;
## 
## The following object is masked from &#39;package:MASS&#39;:
## 
##     select
## 
## The following objects are masked from &#39;package:stats&#39;:
## 
##     filter, lag
## 
## The following objects are masked from &#39;package:base&#39;:
## 
##     intersect, setdiff, setequal, union</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.alignment</span>(<span class="st">&#39;right&#39;</span>, <span class="dt">row.names =</span> <span class="st">&#39;left&#39;</span>)
<span class="kw">library</span>(mvnormtest)
<span class="kw">library</span>(psych)
<span class="kw">library</span>(ggplot2)</code></pre>
<pre><code>## 
## Attaching package: &#39;ggplot2&#39;
## 
## The following object is masked from &#39;package:psych&#39;:
## 
##     %+%</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(MCMCglmm)</code></pre>
<pre><code>## Loading required package: Matrix
## Loading required package: coda
## Loading required package: lattice
## Loading required package: ape</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">behav_data &lt;-<span class="st"> </span><span class="kw">tbl_df</span>(<span class="kw">read.table</span>(<span class="dt">file =</span> <span class="st">&quot;data/behaviour.csv&quot;</span>,
                                <span class="dt">sep =</span> <span class="st">&#39;,&#39;</span>,
                                <span class="dt">header =</span> <span class="ot">TRUE</span>,
                                <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>))
behav_data</code></pre>
<pre><code>## Source: local data frame [4,286 x 25]
## 
##     ID Sex Grid Year julian         trial_id Obs docil handlevent_year
## 1    4   F   SU 2005    177               NA MRG    28              12
## 2  601   M   AG 2005    165               NA CLS    15               9
## 3  601   M   AG 2005    182 0.44270.2005.182 ADI    17              10
## 4  601   M   AG 2005    224 0.44270.2005.224 ADI     8              12
## 5    5   F   KL 2005    170 0.46255.2005.170 ADI    10              10
## 6    5   F   KL 2005    184               NA MAW    20              11
## 7    5   F   KL 2005    212 0.46255.2005.212 ADI    12              14
## 8    5   F   KL 2005    219               NA ADI    10              15
## 9  603   M   AG 2005    170               NA CLS    17               7
## 10 603   M   AG 2005    173 0.46342.2005.173 ADI    12               8
## .. ... ...  ...  ...    ...              ... ...   ...             ...
## Variables not shown: Study (chr), front (dbl), attack_rate (dbl), back
##   (dbl), ln_attack_latency (dbl), ln_approach_latency (dbl), hole_rate
##   (dbl), jump_rate (dbl), chew (dbl), still (dbl), hang (dbl), groom
##   (dbl), walk (dbl), fecal (dbl), trial_life (int), trial_year (int)</code></pre>
<h2 id="mirror-image-stimulation-pca">Mirror Image Stimulation PCA</h2>
<p>Budaev suggests using the Bartlett's test and the Kaiser–Meyer–Olkin (KMO) measure to assess sampling adequecy. Because the behaviour data contains multiple measures per individual we will first subsample the data, randomly choosing 1 record per individual. Bootstrap 100 times.</p>
<pre class="sourceCode r"><code class="sourceCode r">mis_data &lt;-<span class="st">  </span>behav_data %&gt;%
<span class="st">  </span><span class="kw">select</span>(ID, trial_id, front, attack_rate, back, ln_attack_latency, 
    ln_approach_latency)%&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(front))
    
<span class="co"># Get only complete records of the MIS behaviours</span>
mis_sub_data &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">i =</span> <span class="dv">1</span>:<span class="dv">100</span>, <span class="dt">.combine =</span> <span class="st">&#39;rbind&#39;</span>) %dopar%<span class="st"> </span>{
  mis_data %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(ID) %&gt;%
<span class="st">  </span><span class="kw">do</span>(<span class="kw">sample_n</span>(., <span class="dv">1</span>)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">itt =</span> i)
}
<span class="kw">save</span>(mis_data, mis_sub_data, <span class="dt">file =</span> <span class="st">&quot;data/analyses_data/mis_sub.Rdata&quot;</span>)</code></pre>
<h3 id="bartletts-test-kmo">Bartlett's test &amp; KMO</h3>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">&quot;data/analyses_data/mis_sub.Rdata&quot;</span>)
n_trials &lt;-<span class="st"> </span>mis_data %&gt;%<span class="st"> </span><span class="kw">ungroup</span>() %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>())
mis_KMO_Bart &lt;-<span class="st"> </span>mis_sub_data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(itt) %&gt;%
<span class="st">    </span><span class="kw">select</span>(-ID, -trial_id) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(
      <span class="dt">KMO_MSA =</span> <span class="kw">KMO</span>(<span class="kw">cbind</span>(front, attack_rate, back, 
        ln_attack_latency, ln_approach_latency))$MSA,
      <span class="dt">cortest.bartlett =</span> <span class="kw">cortest.bartlett</span>(<span class="dt">R =</span> <span class="kw">cor</span>(<span class="kw">cbind</span>(front, 
        attack_rate, back, ln_attack_latency, 
        ln_approach_latency)), <span class="dt">n =</span> n_trials$n)$chisq
      )

p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(mis_KMO_Bart, <span class="kw">aes</span>(<span class="dt">x =</span> KMO_MSA))
p &lt;-<span class="st"> </span>p +<span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="fl">0.01</span>)
p +<span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Bootstrapped KMO MSA values&quot;</span>) +<span class="st"> </span><span class="kw">xlim</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</code></pre>
<pre><code>## Warning: position_stack requires constant width: output may be incorrect</code></pre>
<div class="figure">
<img src="figure/01_bartlett1.png" />
</div>
<pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(mis_KMO_Bart, <span class="kw">aes</span>(<span class="dt">x =</span> cortest.bartlett))
p &lt;-<span class="st"> </span>p +<span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">10</span>)
p &lt;-<span class="st"> </span>p +<span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Bootstrapped cortest.bartlett chi-sq values&quot;</span>)
p +<span class="st"> </span><span class="kw">xlim</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1000</span>)) +<span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;chi-square (deg. free = 10)&quot;</span>)</code></pre>
<div class="figure">
<img src="figure/01_bartlett2.png" />
</div>
<p>The overall measure of sampling adequecy is fine (Measure of Sampling Adequacy = 0.7415). Bartletts test unsurprisingly rejects the hypotheses that all correlations are zero (P = 0).</p>
<h3 id="multivariate-normality">Multivariate normality</h3>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">&quot;data/analyses_data/mis_sub.Rdata&quot;</span>)
mis_one &lt;-<span class="st"> </span>mis_sub_data %&gt;%<span class="st"> </span><span class="kw">filter</span>(itt ==<span class="st"> </span><span class="dv">1</span>)
<span class="kw">mshapiro.test</span>(<span class="kw">t</span>(<span class="kw">as.matrix</span>(mis_one[-<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">8</span>)])))</code></pre>
<pre><code>## 
##  Shapiro-Wilk normality test
## 
## data:  Z
## W = 0.5897, p-value &lt; 2.2e-16</code></pre>
<p>The data are not multi-normal. In our case this isn't a major problem because we are not performing any statistical tests alongside the PCA, we are just using the PCA to reduce the dimensionality of the data. We will note that the data are not multivariate normal.</p>
<h3 id="pseudo-replication">Pseudo-replication</h3>
<p>Because our data contains multiple records per individual we will check to be sure pesudo-replication isn't having a large effect on the PCA loadings.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">&quot;data/analyses_data/mis_sub.Rdata&quot;</span>)
<span class="co"># Calculate PCA for subsampled data</span>
mis_pca &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">i =</span> <span class="dv">1</span>:<span class="dv">100</span>, <span class="dt">.combine =</span> rbind) %do%<span class="st"> </span>{
  foo &lt;-<span class="st"> </span>mis_sub_data %&gt;%<span class="st"> </span><span class="kw">filter</span>(itt ==<span class="st"> </span>i)
  pc_loadings &lt;-<span class="st"> </span><span class="kw">prcomp</span>(foo[-<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">8</span>)], <span class="dt">scale =</span> <span class="ot">TRUE</span>)$rotation[ ,<span class="st">&quot;PC1&quot;</span>]
  if(<span class="kw">sign</span>(pc_loadings[<span class="st">&quot;front&quot;</span>]) ==<span class="st"> </span>-<span class="dv">1</span>) {pc_loadings &lt;-<span class="st"> </span>pc_loadings *<span class="st"> </span>-<span class="dv">1</span>}
  pc_loadings
}

mis_pca &lt;-<span class="st"> </span><span class="kw">gather</span>(<span class="kw">data.frame</span>(mis_pca), front, attack_rate, back, ln_attack_latency, ln_approach_latency, <span class="dt">key =</span> <span class="st">&quot;trait&quot;</span>, <span class="dt">value =</span> <span class="st">&quot;loading&quot;</span>)

<span class="co"># Calculate PCA for full dataset</span>
mis_pca_full &lt;-<span class="st"> </span><span class="kw">prcomp</span>(mis_data[-<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>, <span class="dv">8</span>)], <span class="dt">scale =</span> <span class="ot">TRUE</span>)

mis_pca_loadings &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">trait =</span> <span class="kw">dimnames</span>(mis_pca_full$rotation)[[<span class="dv">1</span>]],
                        <span class="dt">loading =</span> mis_pca_full$rotation[ ,<span class="st">&quot;PC1&quot;</span>])

if(<span class="kw">sign</span>(mis_pca_loadings$loading[mis_pca_loadings$trait ==<span class="st"> &quot;front&quot;</span>]) ==<span class="st"> </span>-<span class="dv">1</span>) {
  mis_pca_loadings$loading &lt;-<span class="st"> </span>mis_pca_loadings$loading *<span class="st"> </span>-<span class="dv">1</span>
}

p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(mis_pca, <span class="kw">aes</span>(<span class="dt">x =</span> loading))
p &lt;-<span class="st"> </span>p +<span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="fl">0.01</span>) +<span class="st"> </span><span class="kw">facet_wrap</span>( ~<span class="st"> </span>trait)
p +<span class="st"> </span><span class="kw">geom_vline</span>(<span class="dt">data =</span> mis_pca_loadings,
      <span class="kw">aes</span>(<span class="dt">xintercept =</span> loading), <span class="dt">color =</span> <span class="st">&#39;red&#39;</span>)</code></pre>
<p><img src="figure/01_misPCA.png" /> The loadings for PC 1 are nearly identical (subsampled to 1 trial per indidivual vs. full dataset). So we will continue with the loadings from the full dataset so that they are consistent with Taylor et al. 2012.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#  Reverse sign if &#39;front&#39; is negative. This way higher scores will always be </span>
<span class="co">#  more aggressive. Sign of pc scores is arbitrary. Make sure to reverse scores </span>
<span class="co">#  and loadings or else confusion!</span>
if(mis_pca_full$rotation[<span class="st">&quot;front&quot;</span>, <span class="st">&quot;PC1&quot;</span>] &lt;<span class="st"> </span><span class="dv">0</span>){
    mis_pca_full$rotation &lt;-<span class="st"> </span>-<span class="dv">1</span> *<span class="st"> </span>(mis_pca_full$rotation)
    mis_scores &lt;-<span class="st"> </span><span class="kw">data.frame</span>(-mis_pca_full$x)
    } else {
    mis_scores &lt;-<span class="st"> </span><span class="kw">data.frame</span>(mis_pca_full$x)
}

<span class="co"># reattach scores to trail.id (which was rowname after PCA)</span>
mis_pca_scores &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">trial_id =</span> mis_data$trial_id,
                   <span class="dt">misPC1 =</span> mis_scores$PC1,
                   <span class="dt">misPC2 =</span> mis_scores$PC2,
                   <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)

mis_pca_summary &lt;-<span class="st"> </span><span class="kw">rbind</span>(mis_pca_full$rotation,
  <span class="dt">StdDev =</span> mis_pca_full$sdev,
  <span class="dt">PropVar =</span> mis_pca_full$sdev^<span class="dv">2</span> /<span class="st"> </span><span class="kw">sum</span>(mis_pca_full$sdev^<span class="dv">2</span>))</code></pre>
<h2 id="open-field-arena-pca">Open Field Arena PCA</h2>
<p>Following same procedure as above, now for the open field behavioural measures.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Get only complete records of the MIS behaviours</span>
of_data &lt;-<span class="st"> </span>behav_data %&gt;%
<span class="st">             </span><span class="kw">select</span>(ID, trial_id, hole_rate,jump_rate, chew, still, hang,
              groom, walk, fecal) %&gt;%
<span class="st">             </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(hole_rate))

of_sub_data &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">i =</span> <span class="dv">1</span>:<span class="dv">100</span>, <span class="dt">.combine =</span> <span class="st">&#39;rbind&#39;</span>) %dopar%<span class="st"> </span>{
  of_data %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(ID) %&gt;%
<span class="st">  </span><span class="kw">do</span>(<span class="kw">sample_n</span>(., <span class="dv">1</span>)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">itt =</span> i)  
}
<span class="kw">save</span>(of_data, of_sub_data, <span class="dt">file =</span> <span class="st">&quot;data/analyses_data/of_sub_data.RData&quot;</span>)</code></pre>
<h3 id="bartletts-test-kmo-1">Bartlett's test &amp; KMO</h3>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">&quot;data/analyses_data/of_sub_data.RData&quot;</span>)
n_trials &lt;-<span class="st"> </span>of_data %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>())
of_KMO_Bart &lt;-<span class="st"> </span>of_sub_data %&gt;%
<span class="st">                </span><span class="kw">group_by</span>(itt) %&gt;%
<span class="st">                </span><span class="kw">select</span>(-ID, -trial_id) %&gt;%
<span class="st">                </span><span class="kw">summarise</span>(
                  <span class="dt">KMO_MSA =</span> <span class="kw">KMO</span>(<span class="kw">cbind</span>(hole_rate, jump_rate, chew, still, hang, 
                    groom, walk, fecal))$MSA,
                  <span class="dt">cortest.bartlett =</span> <span class="kw">cortest.bartlett</span>(<span class="dt">R =</span> <span class="kw">cor</span>(<span class="kw">cbind</span>(hole_rate, 
                    jump_rate, chew, still, hang, groom, walk, fecal)),
                    <span class="dt">n =</span> n_trials$n)$chisq
                  )

p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(of_KMO_Bart, <span class="kw">aes</span>(<span class="dt">x =</span> KMO_MSA)) +<span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="fl">0.01</span>)
p +<span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Bootstrapped KMO MSA values&quot;</span>) +<span class="st"> </span><span class="kw">xlim</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</code></pre>
<pre><code>## Warning: position_stack requires constant width: output may be incorrect</code></pre>
<div class="figure">
<img src="figure/01_of_bartlett1.png" />
</div>
<pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(of_KMO_Bart, <span class="kw">aes</span>(<span class="dt">x =</span> cortest.bartlett))
p &lt;-<span class="st"> </span>p +<span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">5</span>)
p &lt;-<span class="st"> </span>p +<span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Bootstrapped cortest.bartlett chi-sq values&quot;</span>)
p +<span class="st"> </span><span class="kw">xlim</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1300</span>)) +<span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Chisq&quot;</span>)</code></pre>
<div class="figure">
<img src="figure/01_of_bartlett2.png" />
</div>
<p>The overall measure of sampling adequecy is a bit low, maybe..., (MSA = 0.6419). Again, Bartlett's test rejects the hypotheses that all correlations are zero (P = 0).</p>
<p>Lets take a closer look at the KMO test.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">&quot;data/analyses_data/of_sub_data.RData&quot;</span>)
kmo_of &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">i =</span> <span class="dv">1</span>:<span class="dv">100</span>, <span class="dt">.combine =</span> <span class="st">&#39;rbind&#39;</span>) %do%<span class="st"> </span>{
  foo &lt;-<span class="st"> </span>of_sub_data %&gt;%<span class="st"> </span><span class="kw">ungroup</span>() %&gt;%<span class="st"> </span><span class="kw">filter</span>(itt ==<span class="st"> </span>i)
  <span class="kw">KMO</span>(foo[ ,<span class="kw">c</span>(-<span class="dv">1</span>,-<span class="dv">2</span>,-<span class="dv">11</span>)])$MSAi
}
kmo_of &lt;-<span class="st"> </span><span class="kw">tbl_df</span>(<span class="kw">data.frame</span>(kmo_of))

p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">gather</span>(kmo_of, hole_rate, jump_rate, chew, still, hang, groom, walk, fecal, <span class="dt">key =</span> <span class="st">&quot;behav&quot;</span>, <span class="dt">value =</span> <span class="st">&quot;KMO&quot;</span>), <span class="kw">aes</span>(<span class="dt">x =</span> KMO))
p &lt;-<span class="st"> </span>p +<span class="st"> </span><span class="kw">facet_wrap</span>( ~<span class="st"> </span>behav) +<span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="fl">0.02</span>) +<span class="st"> </span><span class="kw">xlim</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))
p +<span class="st"> </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="fl">0.7</span>, <span class="dt">color =</span> <span class="st">&#39;red&#39;</span>)</code></pre>
<div class="figure">
<img src="figure/01_closer_look_KMO.png" />
</div>
<p>Looks like the low overall KMO index is driven by grooming and hanging. Both of which don't factor in very highly in the PCA loadings. I think therefore this is OK.</p>
<h3 id="multivariate-normality-1">Multivariate normality</h3>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">&quot;data/analyses_data/of_sub_data.RData&quot;</span>)
of_one &lt;-<span class="st"> </span>of_sub_data %&gt;%<span class="st"> </span><span class="kw">filter</span>(itt ==<span class="st"> </span><span class="dv">1</span>)
<span class="kw">mshapiro.test</span>(<span class="kw">t</span>(<span class="kw">as.matrix</span>(of_one[-<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">11</span>)])))</code></pre>
<pre><code>## 
##  Shapiro-Wilk normality test
## 
## data:  Z
## W = 0.7185, p-value &lt; 2.2e-16</code></pre>
<p>The open field data are also not multi-normal (P = 2.4153 × 10<sup>-24</sup>).</p>
<h3 id="pseudo-replication-1">Pseudo-replication</h3>
<p>Because our data contains multiple records per individual we will check to be sure pesudo-replication isn't having a large effect on the PCA loadings.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">&quot;data/analyses_data/of_sub_data.RData&quot;</span>)
<span class="co"># Calculate PCA for subsampled data</span>
of_pca &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">i =</span> <span class="dv">1</span>:<span class="dv">100</span>, <span class="dt">.combine =</span> rbind) %do%<span class="st"> </span>{
  foo &lt;-<span class="st"> </span>of_sub_data %&gt;%<span class="st"> </span><span class="kw">filter</span>(itt ==<span class="st"> </span>i)
  pc_loadings &lt;-<span class="st"> </span><span class="kw">prcomp</span>(foo[-<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">11</span>)], <span class="dt">scale =</span> <span class="ot">TRUE</span>)$rotation[ ,<span class="st">&quot;PC1&quot;</span>]
  if(<span class="kw">sign</span>(pc_loadings[<span class="st">&quot;still&quot;</span>]) ==<span class="st"> </span><span class="dv">1</span>) {pc_loadings &lt;-<span class="st"> </span>pc_loadings *<span class="st"> </span>-<span class="dv">1</span>}
}

of_pca &lt;-<span class="st"> </span><span class="kw">gather</span>(<span class="kw">data.frame</span>(of_pca), hole_rate, jump_rate, chew, still, hang, groom, walk, fecal, <span class="dt">key =</span> <span class="st">&quot;trait&quot;</span>, <span class="dt">value =</span> <span class="st">&quot;loading&quot;</span>)

<span class="co"># Calculate PCA for full dataset</span>
of_pca_full &lt;-<span class="st"> </span><span class="kw">prcomp</span>(of_data[-<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">11</span>)], <span class="dt">scale =</span> <span class="ot">TRUE</span>)

of_pca_loadings &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">trait =</span> <span class="kw">dimnames</span>(of_pca_full$rotation)[[<span class="dv">1</span>]],
                       <span class="dt">loading =</span> of_pca_full$rotation[ ,<span class="st">&quot;PC1&quot;</span>])

if(<span class="kw">sign</span>(of_pca_loadings$loading[of_pca_loadings$trait ==<span class="st"> &quot;still&quot;</span>]) ==<span class="st"> </span><span class="dv">1</span>) {
  of_pca_loadings$loading &lt;-<span class="st"> </span>of_pca_loadings$loading *<span class="st"> </span>-<span class="dv">1</span>
}

p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(of_pca, <span class="kw">aes</span>(<span class="dt">x =</span> loading)) +<span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="fl">0.01</span>)
p &lt;-<span class="st"> </span>p +<span class="st"> </span><span class="kw">facet_wrap</span>( ~<span class="st"> </span>trait) 
p +<span class="st"> </span><span class="kw">geom_vline</span>(<span class="dt">data =</span> of_pca_loadings, <span class="kw">aes</span>(<span class="dt">xintercept =</span> loading), <span class="dt">color =</span> <span class="st">&#39;red&#39;</span>)</code></pre>
<div class="figure">
<img src="figure/01_ofPCA.png" />
</div>
<p>Once again the loadings for PC 1 are spot on the modes of the bootstrap distribution. So we will continue with the loadings from the full dataset so that they are consistent with Taylor et al. 2012. Interestingly, hang and groom have the largest bootstrap variance, and these were the triats identified by the KMO test as not being sampled adequately.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">&quot;data/analyses_data/of_sub_data.RData&quot;</span>)
of_pca_full &lt;-<span class="st"> </span><span class="kw">prcomp</span>(of_data[-<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">11</span>)], <span class="dt">scale =</span> <span class="ot">TRUE</span>)
<span class="co">#  If the pc coefficient for still is positive, then reverse sign of PC scores</span>
<span class="co">#  so that high PC1 is more active.</span>
if(of_pca_full$rotation[<span class="st">&quot;still&quot;</span>, <span class="st">&quot;PC1&quot;</span>] &gt;<span class="st"> </span><span class="dv">0</span>){
    of_pca_full$rotation &lt;-<span class="st"> </span>-<span class="dv">1</span> *<span class="st"> </span>(of_pca_full$rotation)
    of_scores &lt;-<span class="st"> </span><span class="kw">data.frame</span>(-of_pca_full$x)
    } else {
    of_scores &lt;-<span class="st"> </span><span class="kw">data.frame</span>(of_pca_full$x)
}

<span class="co">#  Get scores</span>
of_pca_scores &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">trial_id =</span> of_data$trial_id, <span class="dt">ofPC1 =</span> of_scores$PC1, 
  <span class="dt">ofPC2 =</span> of_scores$PC2, <span class="dt">ofPC3 =</span> of_scores$PC3, <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)

of_pca_summary &lt;-<span class="st"> </span><span class="kw">rbind</span>(of_pca_full$rotation, <span class="dt">StdDev =</span> of_pca_full$sdev, 
  <span class="dt">PropVar =</span> of_pca_full$sdev^<span class="dv">2</span> /<span class="st"> </span><span class="kw">sum</span>(of_pca_full$sdev^<span class="dv">2</span>))

<span class="co"># Save score data</span>
<span class="kw">save</span>(mis_pca_summary, of_pca_summary,
  <span class="dt">file =</span> <span class="st">&quot;data/analyses_data/pca.RData&quot;</span>)</code></pre>
<h2 id="merge-pca-data">Merge PCA data</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(<span class="st">&quot;data/analyses_data/pca.RData&quot;</span>)

<span class="co"># merge pc scores with rest of data by trial id.</span>
pca_data &lt;-<span class="st"> </span><span class="kw">left_join</span>(behav_data, mis_pca_scores, <span class="dt">by =</span> <span class="st">&quot;trial_id&quot;</span>)
pca_data &lt;-<span class="st"> </span><span class="kw">left_join</span>(pca_data, of_pca_scores, <span class="dt">by =</span> <span class="st">&quot;trial_id&quot;</span>)

<span class="kw">save</span>(pca_data, mis_pca_summary, of_pca_summary,
  <span class="dt">file =</span> <span class="st">&quot;data/analyses_data/pca.RData&quot;</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">of_table &lt;-<span class="st"> </span><span class="kw">c</span>(of_pca_summary[<span class="st">&quot;walk&quot;</span>,<span class="dv">1</span>], of_pca_summary[<span class="st">&quot;jump_rate&quot;</span>,<span class="dv">1</span>], 
              of_pca_summary[<span class="st">&quot;hole_rate&quot;</span>,<span class="dv">1</span>], of_pca_summary[<span class="st">&quot;fecal&quot;</span>,<span class="dv">1</span>], 
              of_pca_summary[<span class="st">&quot;hang&quot;</span>,<span class="dv">1</span>], of_pca_summary[<span class="st">&quot;chew&quot;</span>,<span class="dv">1</span>], 
              of_pca_summary[<span class="st">&quot;groom&quot;</span>,<span class="dv">1</span>], of_pca_summary[<span class="st">&quot;still&quot;</span>,<span class="dv">1</span>], 
              of_pca_summary[<span class="st">&quot;StdDev&quot;</span>,<span class="dv">1</span>], of_pca_summary[<span class="st">&quot;PropVar&quot;</span>,<span class="dv">1</span>] *<span class="st"> </span><span class="dv">100</span>)
of_table &lt;-<span class="st"> </span><span class="kw">format</span>(of_table, <span class="dt">nsmall =</span> <span class="dv">2</span>, <span class="dt">digits =</span> <span class="dv">0</span>)

mis_table &lt;-<span class="st"> </span><span class="kw">c</span>(mis_pca_summary[<span class="st">&quot;front&quot;</span>,<span class="dv">1</span>], mis_pca_summary[<span class="st">&quot;attack_rate&quot;</span>,<span class="dv">1</span>],
               mis_pca_summary[<span class="st">&quot;back&quot;</span>,<span class="dv">1</span>], 
               mis_pca_summary[<span class="st">&quot;ln_attack_latency&quot;</span>,<span class="dv">1</span>],
               mis_pca_summary[<span class="st">&quot;ln_approach_latency&quot;</span>,<span class="dv">1</span>], 
               mis_pca_summary[<span class="st">&quot;StdDev&quot;</span>,<span class="dv">1</span>],
               mis_pca_summary[<span class="st">&quot;PropVar&quot;</span>,<span class="dv">1</span>] *<span class="st"> </span><span class="dv">100</span>)
mis_table &lt;-<span class="kw">format</span>(mis_table, <span class="dt">nsmall =</span> <span class="dv">2</span>, <span class="dt">digits =</span> <span class="dv">0</span>)


pca_table &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">check.names =</span> <span class="ot">FALSE</span>,
  <span class="st">&quot;OF Behaviour&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Walk&quot;</span>, <span class="st">&quot;Jump Rate&quot;</span>, <span class="st">&quot;Hole Rate&quot;</span>, <span class="st">&quot;No. Pellets&quot;</span>, <span class="st">&quot;Hang&quot;</span>,
  <span class="st">&quot;Chew&quot;</span>, <span class="st">&quot;Groom&quot;</span>, <span class="st">&quot;Still&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;Std. Dev.&quot;</span>, <span class="st">&quot;% Total variance&quot;</span>, <span class="st">&quot;N records&quot;</span>,
  <span class="st">&quot;N individuals&quot;</span>),
  <span class="st">&quot;OF PC1&quot;</span> =<span class="st"> </span><span class="kw">c</span>(of_table[<span class="dv">1</span>:<span class="dv">8</span>], <span class="st">&quot;&quot;</span>, of_table[<span class="dv">9</span>:<span class="dv">10</span>], <span class="kw">nrow</span>(behav_data %&gt;%
<span class="st">                 </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(still))), <span class="kw">nrow</span>(of_data %&gt;%<span class="st"> </span><span class="kw">select</span>(ID) %&gt;%
<span class="st">                 </span><span class="kw">unique</span>())),
  <span class="st">&quot;MIS Behaviour&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Front&quot;</span>, <span class="st">&quot;Attack rate&quot;</span>, <span class="st">&quot;Back&quot;</span>, <span class="st">&quot;Attack latency&quot;</span>,
  <span class="st">&quot;Approach latency&quot;</span>, <span class="kw">rep</span>(<span class="st">&quot;&quot;</span>, <span class="dv">8</span>)),
  <span class="st">&quot;MIS PC1&quot;</span> =<span class="st"> </span><span class="kw">c</span>(mis_table[<span class="dv">1</span>:<span class="dv">5</span>], <span class="kw">rep</span>(<span class="st">&quot;&quot;</span>, <span class="dv">4</span>), mis_table[<span class="dv">6</span>:<span class="dv">7</span>], 
  <span class="kw">nrow</span>(behav_data %&gt;%<span class="st"> </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(front))), <span class="kw">nrow</span>(mis_data %&gt;%
<span class="st">  </span><span class="kw">select</span>(ID) %&gt;%<span class="st"> </span><span class="kw">unique</span>()))
  )
<span class="kw">pandoc.table</span>(pca_table)</code></pre>
<table>
<col width="23%" />
<col width="12%" />
<col width="23%" />
<col width="12%" />
<thead>
<tr class="header">
<th align="right">OF Behaviour</th>
<th align="right">OF PC1</th>
<th align="right">MIS Behaviour</th>
<th align="right">MIS PC1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">Walk</td>
<td align="right">0.47</td>
<td align="right">Front</td>
<td align="right">0.49</td>
</tr>
<tr class="even">
<td align="right">Jump Rate</td>
<td align="right">0.46</td>
<td align="right">Attack rate</td>
<td align="right">0.38</td>
</tr>
<tr class="odd">
<td align="right">Hole Rate</td>
<td align="right">0.31</td>
<td align="right">Back</td>
<td align="right">-0.41</td>
</tr>
<tr class="even">
<td align="right">No. Pellets</td>
<td align="right">0.30</td>
<td align="right">Attack latency</td>
<td align="right">-0.47</td>
</tr>
<tr class="odd">
<td align="right">Hang</td>
<td align="right">0.20</td>
<td align="right">Approach latency</td>
<td align="right">-0.48</td>
</tr>
<tr class="even">
<td align="right">Chew</td>
<td align="right">0.26</td>
<td align="right"></td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="right">Groom</td>
<td align="right">-0.04</td>
<td align="right"></td>
<td align="right"></td>
</tr>
<tr class="even">
<td align="right">Still</td>
<td align="right">-0.53</td>
<td align="right"></td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="right">Std. Dev.</td>
<td align="right">1.67</td>
<td align="right"></td>
<td align="right">1.67</td>
</tr>
<tr class="even">
<td align="right">% Total variance</td>
<td align="right">34.73</td>
<td align="right"></td>
<td align="right">55.79</td>
</tr>
<tr class="odd">
<td align="right">N records</td>
<td align="right">556</td>
<td align="right"></td>
<td align="right">553</td>
</tr>
<tr class="even">
<td align="right">N individuals</td>
<td align="right">365</td>
<td align="right"></td>
<td align="right">364</td>
</tr>
</tbody>
</table>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># sample sizes</span>
n_docil &lt;-<span class="st"> </span>pca_data %&gt;%<span class="st"> </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(docil)) %&gt;%
<span class="st">            </span><span class="kw">group_by</span>(ID) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>())

n_oft &lt;-<span class="st"> </span>pca_data %&gt;%<span class="st"> </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(misPC1)) %&gt;%
<span class="st">           </span><span class="kw">group_by</span>(ID) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>())

s_table &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">check.names =</span> <span class="ot">FALSE</span>,
     <span class="dt">Test =</span> <span class="kw">c</span>(<span class="st">&quot;OF / MIS&quot;</span>, <span class="st">&quot;Handling&quot;</span>),
    <span class="st">&quot;N trials&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="kw">sum</span>(n_oft$n), <span class="kw">sum</span>(n_docil$n)),
    <span class="st">&quot;N individuals&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="kw">length</span>(<span class="kw">unique</span>(n_oft$ID)), <span class="kw">length</span>(<span class="kw">unique</span>(n_docil$ID))),
    <span class="st">&quot;N &gt; 1 trial&quot;</span>   =<span class="st"> </span><span class="kw">c</span>(<span class="kw">length</span>(n_oft$ID[n_oft$n &gt;<span class="st"> </span><span class="dv">1</span>]),
                        <span class="kw">length</span>(n_docil$ID[n_docil$n &gt;<span class="st"> </span><span class="dv">1</span>]))
    )
<span class="kw">pandoc.table</span>(s_table)</code></pre>
<table>
<col width="12%" />
<col width="15%" />
<col width="22%" />
<col width="18%" />
<thead>
<tr class="header">
<th align="center">Test</th>
<th align="center">N trials</th>
<th align="center">N individuals</th>
<th align="center">N &gt; 1 trial</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">OF / MIS</td>
<td align="center">553</td>
<td align="center">364</td>
<td align="center">165</td>
</tr>
<tr class="even">
<td align="center">Handling</td>
<td align="center">4227</td>
<td align="center">869</td>
<td align="center">621</td>
</tr>
</tbody>
</table>
</body>
</html>